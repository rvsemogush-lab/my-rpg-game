<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–ö: –ù–∞—Å–ª–µ–¥–∏–µ (–ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <!-- –ú—ã –∑–∞–≥—Ä—É–∑–∏–º PeerJS –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å (Cloudflare) -->
    <script src="https://cdnjs.cloudflare.com"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #ccc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .screen { display: none; width: 100%; max-width: 400px; border: 2px solid #444; padding: 20px; background: #222; }
        .active { display: block; }
        .stat-row { margin: 10px 0; display: flex; justify-content: space-between; }
        #game-log { height: 150px; border: 1px solid #555; overflow-y: auto; background: #000; padding: 10px; margin: 10px 0; font-size: 12px; }
        button { cursor: pointer; padding: 8px; background: #333; color: #fff; border: 1px solid #555; margin-bottom: 5px; }
        button:hover { background: #444; }
        #qrcode-container { background: white; padding: 5px; width: 150px; height: 150px; margin: 10px auto; }
        input { background: #000; color: #4a2; border: 1px solid #444; padding: 8px; width: 90%; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="char-creation" class="screen active">
        <h2>‚öîÔ∏è –ù–æ–≤—ã–π –ì–µ—Ä–æ–π</h2>
        <input type="text" id="p-name" placeholder="–ò–º—è –≥–µ—Ä–æ—è..." maxlength="12">
        <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏: <b id="f-pts">25</b></p>
        <div class="stat-row">–°–∏–ª–∞: <span id="s-str">0</span> <button onclick="addStat('str')">+</button></div>
        <div class="stat-row">–õ–æ–≤–∫–æ—Å—Ç—å: <span id="s-dex">0</span> <button onclick="addStat('dex')">+</button></div>
        <div class="stat-row">–£–¥–∞—á–∞: <span id="s-luk">0</span> <button onclick="addStat('luk')">+</button></div>
        <button style="width:100%; background: #4a2;" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
    </div>

    <div id="city-screen" class="screen">
        <h2>üè∞ –ì–æ—Ä–æ–¥</h2>
        <button style="width:100%" onclick="initNet()">üåê –°–µ—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º (PvP)</button>
        <div id="c-info" style="margin-top:20px; border-left: 3px solid #4a2; padding-left: 10px;"></div>
    </div>

    <div id="net-screen" class="screen">
        <h2>üåê –°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞</h2>
        <p id="p-status" style="font-size: 12px;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</p>
        <div id="qrcode-container"></div>
        <input type="text" id="peer-id-input" placeholder="–í—Å—Ç–∞–≤—å ID –¥—Ä—É–≥–∞">
        <button onclick="joinNet()" style="width:100%; background: #2a5;">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="showScreen('city-screen')" style="width:100%">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="combat-screen" class="screen">
        <div style="display:flex; justify-content:space-between; font-weight: bold;">
            <div id="p-hp" style="color: #4a2;">–í—ã: 100</div>
            <div id="e-hp" style="color: #f44;">–í—Ä–∞–≥: 100</div>
        </div>
        <div id="game-log"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
            <button onclick="setZ('atk','–ì–æ–ª–æ–≤–∞')">–ê:–ì–æ–ª</button>
            <button onclick="setZ('atk','–¢–µ–ª–æ')">–ê:–¢–µ–ª</button>
            <button onclick="setZ('atk','–ù–æ–≥–∏')">–ê:–ù–æ–≥</button>
            <button onclick="setZ('blk','–ì–æ–ª–æ–≤–∞')">–ó:–ì–æ–ª</button>
            <button onclick="setZ('blk','–¢–µ–ª–æ')">–ó:–¢–µ–ª</button>
            <button onclick="setZ('blk','–ù–æ–≥–∏')">–ó:–ù–æ–≥</button>
        </div>
        <button id="hit-btn" disabled style="width:100%; height: 50px; background:#4a2; margin-top:10px;" onclick="doTurn()">–£–î–ê–†–ò–¢–¨</button>
    </div>

<script>
// –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let p = { name: "–ì–µ—Ä–æ–π", str: 0, dex: 0, luk: 0, pts: 25, hp: 100, max: 100 };
let enemy = { name: "–í—Ä–∞–≥", hp: 0, max: 0, str: 5 };
let sel = { atk: null, blk: null };
let peer, conn, rem = null;

// –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    updateUI();
}

function addStat(s) {
    if (p.pts > 0) { p[s]++; p.pts--; updateUI(); }
}

function updateUI() {
    p.max = 100 + (p.str * 10);
    document.getElementById('f-pts').innerText = p.pts;
    document.getElementById('s-str').innerText = p.str;
    document.getElementById('s-dex').innerText = p.dex;
    document.getElementById('s-luk').innerText = p.luk;
    if(document.getElementById('c-info')) {
        document.getElementById('c-info').innerHTML = `<b>${p.name}</b><br>–ó–¥–æ—Ä–æ–≤—å–µ: ${p.hp}/${p.max}<br>–°–∏–ª–∞: ${p.str}`;
    }
}

function startGame() {
    p.name = document.getElementById('p-name').value || "–ì–µ—Ä–æ–π";
    p.hp = p.max;
    showScreen('city-screen');
}

// –°–µ—Ç–µ–≤–∞—è –ª–æ–≥–∏–∫–∞
function initNet() {
    showScreen('net-screen');
    if (peer) return;

    // –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç Peer. –ï—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ—Ç - –≤—ã—Å–∫–æ—á–∏—Ç –æ—à–∏–±–∫–∞.
    try {
        peer = new Peer();
        
        peer.on('open', (id) => {
            document.getElementById('p-status').innerText = "–¢–≤–æ–π ID: " + id;
            document.getElementById('qrcode-container').innerHTML = 
                '<img src="https://api.qrserver.com' + id + '" width="150">';
        });

        peer.on('connection', (c) => {
            conn = c;
            setupConn();
        });

        peer.on('error', (err) => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.type);
        });
    } catch (e) {
        alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ PeerJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏ —Ä–µ–∫–ª–∞–º—ã.");
    }
}

function joinNet() {
    const id = document.getElementById('peer-id-input').value;
    if(id && peer) {
        conn = peer.connect(id);
        setupConn();
    }
}

function setupConn() {
    conn.on('open', () => {
        showScreen('combat-screen');
        enemy.name = "–°–æ–ø–µ—Ä–Ω–∏–∫";
        conn.send({ t: 'INIT', n: p.name, h: p.max, s: p.str });
        log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –í—ã–±–µ—Ä–∏ –∑–æ–Ω—ã –∞—Ç–∞–∫–∏ –∏ –∑–∞—â–∏—Ç—ã.", "#4a2");
    });
    
    conn.on('data', (d) => {
        if(d.t === 'INIT') {
            enemy.name = d.n; enemy.hp = d.h; enemy.max = d.h; enemy.str = d.s;
            updC();
        }
        if(d.t === 'TURN') {
            rem = d;
            checkPvP();
        }
    });
}

// –õ–æ–≥–∏–∫–∞ –±–æ—è
function setZ(t, z) {
    sel[t] = z;
    if(sel.atk && sel.blk) {
        document.getElementById('hit-btn').disabled = false;
        document.getElementById('hit-btn').innerText = "–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –•–û–î";
    }
}

function doTurn() {
    if(!conn) return;
    conn.send({ t: 'TURN', a: sel.atk, b: sel.blk });
    document.getElementById('hit-btn').disabled = true;
    document.getElementById('hit-btn').innerText = "–û–ñ–ò–î–ê–ù–ò–ï...";
    log("–•–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...", "#aaa");
    checkPvP();
}

function checkPvP() {
    if(sel.atk && rem) {
        log("--- –†–ï–ó–£–õ–¨–¢–ê–¢ –†–ê–£–ù–î–ê ---", "#fff");
        
        // –¢—ã –±—å–µ—à—å
        if(sel.atk === rem.b) {
            log(`–¢–≤–æ–π —É–¥–∞—Ä –≤ ${sel.atk} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`, "#aaa");
        } else {
            let damage = 10 + p.str;
            enemy.hp -= damage;
            log(`–¢—ã –ø–æ–ø–∞–ª –≤ ${sel.atk}! –ù–∞–Ω–µ—Å–µ–Ω–æ ${damage} —É—Ä–æ–Ω–∞.`, "#4a2");
        }
        
        // –¢–µ–±—è –±—å—é—Ç
        if(rem.a === sel.blk) {
            log(`–¢—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —É–¥–∞—Ä –≤ ${sel.blk}!`, "#4a2");
        } else {
            let eDamage = 10 + enemy.str;
            p.hp -= eDamage;
            log(`–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–ø–∞–ª –≤ ${rem.a}! –¢–µ–±–µ –Ω–∞–Ω–µ—Å–µ–Ω–æ ${eDamage} —É—Ä–æ–Ω–∞.`, "#f44");
        }
        
        updC();
        rem = null; 
        sel = { atk: null, blk: null };
        document.getElementById('hit-btn').innerText = "–£–î–ê–†–ò–¢–¨";
        
        if(p.hp <= 0 || enemy.hp <= 0) {
            alert(p.hp > 0 ? "–ü–û–ë–ï–î–ê!" : "–í–´ –ü–†–û–ò–ì–†–ê–õ–ò");
            location.reload();
        }
    }
}

function updC() {
    document.getElementById('p-hp').innerText = "–í—ã: " + p.hp;
    document.getElementById('e-hp').innerText = enemy.name + ": " + enemy.hp;
}

function log(m, c) {
    const l = document.getElementById('game-log');
    l.innerHTML += '<div style="color:' + c + '">' + m + '</div>';
    l.scrollTop = l.scrollHeight;
}
</script>
</body>
</html>
