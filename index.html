<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Å–µ—Ç–∏ –∏ QR -->
<script src="https://cdnjs.cloudflare.com"></script>
<script src="https://cdnjs.cloudflare.com"></script>
<title>–ë–ö: –ù–∞—Å–ª–µ–¥–∏–µ ‚Äî –°–µ—Ç–µ–≤–∞—è –ë–∏—Ç–≤–∞</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #ccc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .screen { display: none; width: 100%; max-width: 500px; border: 2px solid #444; padding: 20px; background: #222; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .active { display: block; }
        .stat-row { margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        #game-log { height: 180px; border: 1px solid #555; overflow-y: auto; background: #000; padding: 10px; margin: 15px 0; font-size: 13px; color: #aaa; }
        button { cursor: pointer; padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; margin-bottom: 5px; transition: 0.2s; }
        button:hover:not(:disabled) { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .location-btn { width: 100%; text-align: left; }
        #char-stats-display { background: #2a2a2a; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 0.85em; border-left: 4px solid #4a2; line-height: 1.4; }
        .item-card { border-bottom: 1px solid #444; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        #qrcode-container { background:#fff; padding:10px; margin:10px auto; width:200px; height:200px; }
        input { background: #000; color: #4a2; border: 1px solid #444; padding: 8px; width: calc(100% - 20px); margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –°–û–ó–î–ê–ù–ò–Ø -->
    <div id="char-creation" class="screen active">
        <h2>‚öîÔ∏è –ù–æ–≤—ã–π –ì–µ—Ä–æ–π</h2>
        <input type="text" id="player-name-input" placeholder="–ò–º—è –≥–µ—Ä–æ—è..." maxlength="12">
        <select id="player-class-select" style="width:100%; padding:8px; background:#000; color:#fff; margin-bottom:10px;">
            <option value="warrior">–í–æ–∏–Ω (+HP, –¢—è–∂–µ–ª–æ–µ)</option>
            <option value="rogue">–†–∞–∑–±–æ–π–Ω–∏–∫ (–õ–æ–≤–∫–æ—Å—Ç—å)</option>
            <option value="lucky">–û—Ö–æ—Ç–Ω–∏–∫ (–£–¥–∞—á–∞)</option>
        </select>
        <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏: <b id="free-points">25</b></p>
        <div class="stat-row">–°–∏–ª–∞: <span id="str">0</span> <button onclick="addStat('str')">+</button></div>
        <div class="stat-row">–õ–æ–≤–∫–æ—Å—Ç—å: <span id="dex">0</span> <button onclick="addStat('dex')">+</button></div>
        <div class="stat-row">–£–¥–∞—á–∞: <span id="luk">0</span> <button onclick="addStat('luk')">+</button></div>
        <button style="width:100%" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –ü–£–¢–¨</button>
    </div>

    <!-- –ì–û–†–û–î -->
    <div id="city-screen" class="screen">
        <h2>üè∞ –ì–æ—Ä–æ–¥</h2>
        <button class="location-btn" onclick="showScreen('map-screen')">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ú–∏—Ä–∞ (PvE)</button>
        <button class="location-btn" onclick="initMultiplayer()">üåê –°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞ (PvP)</button>
        <button class="location-btn" onclick="showScreen('stats-screen')">üë§ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å / –ü—Ä–æ–∫–∞—á–∫–∞</button>
        <button class="location-btn" onclick="openShop()">üí∞ –õ–∞–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤—Ü–∞</button>
        <div id="char-stats-display"></div>
        <button onclick="resetSave()" style="color:red; font-size:10px; margin-top:20px; border:none; background:none;">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button>
    </div>

    <!-- –°–ï–¢–ï–í–ê–Ø –ò–ì–†–ê -->
    <div id="multiplayer-screen" class="screen">
        <h2>üåê –°–µ—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º</h2>
        <p id="peer-status">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID...</p>
        <div id="qrcode-container"><canvas id="qrcode"></canvas></div>
        <div id="join-section">
            <input type="text" id="join-id" placeholder="ID –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞">
            <button onclick="joinGame()" style="width:100%">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ ID</button>
        </div>
        <button style="width:100%; margin-top:10px;" onclick="showScreen('city-screen')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –ú–ê–ì–ê–ó–ò–ù -->
    <div id="shop-screen" class="screen">
        <h2>üí∞ –õ–∞–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤—Ü–∞</h2>
        <p>–ó–æ–ª–æ—Ç–æ: <b id="player-gold">0</b></p>
        <div id="shop-items-list" style="height: 300px; overflow-y: auto;"></div>
        <button style="width:100%" onclick="showScreen('city-screen')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –ü–†–û–ö–ê–ß–ö–ê -->
    <div id="stats-screen" class="screen">
        <h2>üìú –ì–µ—Ä–æ–π</h2>
        <p>–°–≤–æ–±–æ–¥–Ω–æ –æ—á–∫–æ–≤: <b id="curr-free-points">0</b></p>
        <div class="stat-row">–°–∏–ª–∞: <span id="curr-str">0</span> <button onclick="addStat('str')">+</button></div>
        <div class="stat-row">–õ–æ–≤–∫–æ—Å—Ç—å: <span id="curr-dex">0</span> <button onclick="addStat('dex')">+</button></div>
        <div class="stat-row">–£–¥–∞—á–∞: <span id="curr-luk">0</span> <button onclick="addStat('luk')">+</button></div>
        <button style="width:100%" onclick="saveGame(); showScreen('city-screen')">–í –≥–æ—Ä–æ–¥</button>
    </div>

    <!-- –ö–ê–†–¢–ê -->
    <div id="map-screen" class="screen">
        <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞</h2>
        <button class="location-btn" onclick="startBattle('–õ–µ—Å', 1)">üå≤ –õ–µ—Å (–õ–µ–≥–∫–æ)</button>
        <button class="location-btn" onclick="startBattle('–ö–ª–∞–¥–±–∏—â–µ', 3)">ü™¶ –ö–ª–∞–¥–±–∏—â–µ (–°—Ä–µ–¥–Ω–µ)</button>
        <button class="location-btn" onclick="startBattle('–ó–∞–º–æ–∫', 7)">üè∞ –ó–∞–º–æ–∫ (–°–ª–æ–∂–Ω–æ)</button>
        <button style="width:100%" onclick="showScreen('city-screen')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –ë–û–ô -->
    <div id="combat-screen" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
            <div id="p-hp-ui" style="color:#4a2;">–í—ã: 100</div>
            <div id="e-hp-ui" style="color:#ff4d4d;">–í—Ä–∞–≥: 100</div>
        </div>
        <div id="game-log"></div>
        <div id="combat-controls">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
                <button class="atk-z" onclick="setZone('attack','–ì–æ–ª–æ–≤–∞', this)">–ê—Ç:–ì–æ–ª–æ–≤–∞</button>
                <button class="atk-z" onclick="setZone('attack','–ö–æ—Ä–ø—É—Å', this)">–ê—Ç:–ö–æ—Ä–ø—É—Å</button>
                <button class="atk-z" onclick="setZone('attack','–ù–æ–≥–∏', this)">–ê—Ç:–ù–æ–≥–∏</button>
                <button class="blk-z" onclick="setZone('block','–ì–æ–ª–æ–≤–∞', this)">–ó—â:–ì–æ–ª–æ–≤–∞</button>
                <button class="blk-z" onclick="setZone('block','–ö–æ—Ä–ø—É—Å', this)">–ó—â:–ö–æ—Ä–ø—É—Å</button>
                <button class="blk-z" onclick="setZone('block','–ù–æ–≥–∏', this)">–ó—â:–ù–æ–≥–∏</button>
            </div>
            <button id="turn-btn" disabled style="width:100%; background:#4a2; margin-top:10px; font-weight:bold;" onclick="confirmTurn()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –•–û–î</button>
        </div>
    </div>

<script>
// --- –î–ê–ù–ù–´–ï ---
const items = {
    weapon: [
        { id:'w1', name:'–¢–æ–ø–æ—Ä', cost:50, str:4 }, { id:'w2', name:'–ú–æ–ª–æ—Ç', cost:150, str:10 }, { id:'w3', name:'–ú–µ—á –¢—å–º—ã', cost:400, str:25 },
        { id:'s1', name:'–ù–æ–∂', cost:50, dex:4 }, { id:'s2', name:'–ö–∏–Ω–∂–∞–ª—ã', cost:150, dex:10 }, { id:'s3', name:'–†–∞–ø–∏—Ä–∞', cost:400, dex:25 }
    ],
    armor: {
        head: [{id:'h1', name:'–®–∞–ø–∫–∞', cost:30, hp:15}, {id:'h2', name:'–®–ª–µ–º', cost:100, hp:40}],
        body: [{id:'b1', name:'–†—É–±–∞—Ö–∞', cost:40, hp:25}, {id:'b2', name:'–õ–∞—Ç—ã', cost:350, hp:150}],
        legs: [{id:'l1', name:'–®—Ç–∞–Ω—ã', cost:20, hp:10}, {id:'l2', name:'–ü–æ–Ω–æ–∂–∏', cost:250, hp:80}]
    }
};

let p = { 
    name: "–ì–µ—Ä–æ–π", class: "warrior", gold: 100,
    str: 0, dex: 0, luk: 0, points: 25, 
    hp: 100, maxHp: 100, lvl: 1,
    equiped: { weapon: null, head: null, body: null, legs: null }
};

let enemy = { name: "–í—Ä–∞–≥", hp: 0, maxHp: 0, str: 2, isPlayer: false };
let selection = { attack: null, block: null };
let peer, conn, remoteTurn = null;

// --- –°–ò–°–¢–ï–ú–ê ---
window.onload = () => {
    const saved = localStorage.getItem('bk_save_v3');
    if (saved) { p = JSON.parse(saved); showScreen('city-screen'); }
    updateUI();
};

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    updateUI();
}

function addStat(s) {
    if (p.points > 0) { p[s]++; p.points--; updateUI(); }
}

function updateUI() {
    let bHp = (p.equiped.head?.hp || 0) + (p.equiped.body?.hp || 0) + (p.equiped.legs?.hp || 0);
    p.maxHp = 100 + (p.str * 10) + bHp + (p.class==='warrior'?50:0);
    
    const fields = { 'free-points': p.points, 'curr-free-points': p.points, 'str': p.str, 'curr-str': p.str, 'dex': p.dex, 'curr-dex': p.dex, 'luk': p.luk, 'curr-luk': p.luk, 'player-gold': p.gold };
    for (let id in fields) if(document.getElementById(id)) document.getElementById(id).innerText = fields[id];

    const info = document.getElementById('char-stats-display');
    if(info) info.innerHTML = `<b>${p.name}</b> [${p.lvl} —É—Ä.]<br>HP: ${p.hp}/${p.maxHp}<br>–£—Ä–æ–Ω: ${5 + p.str + (p.equiped.weapon?.str||0)}`;
}

function startGame() {
    p.name = document.getElementById('player-name-input').value || "–ì–µ—Ä–æ–π";
    p.class = document.getElementById('player-class-select').value;
    p.hp = p.maxHp;
    showScreen('city-screen');
    saveGame();
}

// --- –ú–ê–ì–ê–ó–ò–ù ---
function openShop() {
    showScreen('shop-screen');
    const list = document.getElementById('shop-items-list');
    list.innerHTML = '';
    const all = [...items.weapon, ...items.armor.head, ...items.armor.body, ...items.armor.legs];
    all.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item-card';
        div.innerHTML = `<span>${item.name} (${item.str?'+'+item.str+'üë§':'+'+item.hp+'‚ù§Ô∏è'})</span><button onclick="buy('${item.id}')">${item.cost}üí∞</button>`;
        list.appendChild(div);
    });
}

function buy(id) {
    let item = [...items.weapon, ...items.armor.head, ...items.armor.body, ...items.armor.legs].find(i => i.id === id);
    if(p.gold >= item.cost) {
        p.gold -= item.cost;
        let cat = items.weapon.find(i=>i.id===id) ? 'weapon' : (items.armor.head.find(i=>i.id===id)?'head':(items.armor.body.find(i=>i.id===id)?'body':'legs'));
        p.equiped[cat] = item;
        updateUI();
        alert("–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ!");
    }
}

// --- –°–ï–¢–¨ ---
function initMultiplayer() {
    showScreen('multiplayer-screen');
    if (peer) return;
    peer = new Peer();
    peer.on('open', id => {
        document.getElementById('peer-status').innerText = "–¢–≤–æ–π ID: " + id;
        const qrImg = `https://api.qrserver.com{id}`;
        document.getElementById('qrcode-container').innerHTML = `<img src="${qrImg}">`;
    peer.on('connection', c => { conn = c; setupConn(); });
}

function joinGame() {
    conn = peer.connect(document.getElementById('join-id').value);
    setupConn();
}

function setupConn() {
    conn.on('open', () => {
        log("–ò–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!", "#4a2");
        showScreen('combat-screen');
        enemy = { name: "–°–æ–ø–µ—Ä–Ω–∏–∫", hp: 100, maxHp: 100, isPlayer: true };
        conn.send({ type: 'INIT', name: p.name, hp: p.maxHp, str: p.str });
    });
    conn.on('data', data => {
        if(data.type === 'INIT') { enemy.name = data.name; enemy.hp = data.hp; enemy.maxHp = data.hp; enemy.str = data.str; updateCombatUI(); }
        if(data.type === 'TURN') { remoteTurn = data; checkPvP(); }
    });
}

// --- –ë–û–ô ---
function startBattle(n, d) {
    enemy = { name: n, hp: 30*d, maxHp: 30*d, str: 2*d, isPlayer: false, lvl: d };
    p.hp = p.maxHp;
    showScreen('combat-screen');
    log(`–í—Å—Ç—Ä–µ—á–µ–Ω ${n}!`, "#fff");
    updateCombatUI();
}

function setZone(type, zone, btn) {
    selection[type] = zone;
    document.querySelectorAll('.' + (type==='attack'?'atk-z':'blk-z')).forEach(b => b.style.borderColor = '#555');
    btn.style.borderColor = '#4a2';
    if(selection.attack && selection.block) document.getElementById('turn-btn').disabled = false;
}

function confirmTurn() {
    if(enemy.isPlayer) {
        conn.send({ type: 'TURN', attack: selection.attack, block: selection.block });
        document.getElementById('turn-btn').disabled = true;
        log("–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...", "#aaa");
        checkPvP();
    } else {
        const zones = ['–ì–æ–ª–æ–≤–∞', '–ö–æ—Ä–ø—É—Å', '–ù–æ–≥–∏'];
        resolve(zones[Math.floor(Math.random()*3)], zones[Math.floor(Math.random()*3)]);
    }
}

function checkPvP() {
    if(selection.attack && remoteTurn) {
        resolve(remoteTurn.attack, remoteTurn.block);
        remoteTurn = null;
        selection = { attack: null, block: null };
        document.querySelectorAll('.atk-z, .blk-z').forEach(b => b.style.borderColor = '#555');
    }
}

function resolve(eAtk, eBlk) {
    log(`--- –†–∞—É–Ω–¥ ---`, "#666");
    // –í—ã –±—å–µ—Ç–µ
    if(selection.attack === eBlk) log(`–í–∞—à —É–¥–∞—Ä –≤ ${selection.attack} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`, "#aaa");
    else {
        let d = 5 + p.str + (p.equiped.weapon?.str||0);
        enemy.hp -= d; log(`–í—ã –ø–æ–ø–∞–ª–∏ –ø–æ ${enemy.name} –Ω–∞ ${d}`, "#4a2");
    }
    // –í–∞—Å –±—å—é—Ç
    if(eAtk === selection.block) log(`–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ —É–¥–∞—Ä –≤ ${eAtk}!`, "#4a2");
    else {
        let ed = 5 + enemy.str;
        p.hp -= ed; log(`${enemy.name} —É–¥–∞—Ä–∏–ª –≤–∞—Å –Ω–∞ ${ed}`, "#f44");
    }
    updateCombatUI();
    if(enemy.hp <= 0 || p.hp <= 0) end(enemy.hp <= 0);
}

function end(win) {
    alert(win ? "–ü–æ–±–µ–¥–∞!" : "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ...");
    if(win && !enemy.isPlayer) { p.gold += enemy.lvl * 20; p.points += 1; }
    p.hp = p.maxHp;
    showScreen('city-screen');
    saveGame();
}

function updateCombatUI() {
    document.getElementById('p-hp-ui').innerText = `–í—ã: ${p.hp} HP`;
    document.getElementById('e-hp-ui').innerText = `${enemy.name}: ${enemy.hp} HP`;
}

function log(m, c) {
    const l = document.getElementById('game-log');
    l.innerHTML += `<div style="color:${c}">${m}</div>`;
    l.scrollTop = l.scrollHeight;
}

function saveGame() { localStorage.setItem('bk_save_v3', JSON.stringify(p)); }
function resetSave() { localStorage.removeItem('bk_save_v3'); location.reload(); }
</script>
</body>
</html>
