<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–ö: –ù–∞—Å–ª–µ–¥–∏–µ ‚Äî –°–µ—Ç–µ–≤–∞—è –ë–∏—Ç–≤–∞</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É -->
    <script src="https://unpkg.com"></script>
    <style>
        body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #ccc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .screen { display: none; width: 100%; max-width: 500px; border: 2px solid #444; padding: 20px; background: #222; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .active { display: block; }
        .stat-row { margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        #game-log { height: 180px; border: 1px solid #555; overflow-y: auto; background: #000; padding: 10px; margin: 15px 0; font-size: 13px; color: #aaa; }
        button { cursor: pointer; padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; margin-bottom: 5px; }
        button:hover:not(:disabled) { background: #555; }
        .location-btn { width: 100%; text-align: left; }
        #char-stats-display { background: #2a2a2a; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 0.85em; border-left: 4px solid #4a2; }
        #qrcode-container { background:#fff; padding:10px; margin:10px auto; width:200px; height:200px; display: flex; align-items: center; justify-content: center; }
        input { background: #000; color: #4a2; border: 1px solid #444; padding: 8px; width: 90%; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="char-creation" class="screen active">
        <h2>‚öîÔ∏è –ù–æ–≤—ã–π –ì–µ—Ä–æ–π</h2>
        <input type="text" id="player-name-input" placeholder="–ò–º—è –≥–µ—Ä–æ—è..." maxlength="12">
        <p>–û—á–∫–∏: <b id="free-points">25</b></p>
        <div class="stat-row">–°–∏–ª–∞: <span id="str">0</span> <button onclick="addStat('str')">+</button></div>
        <div class="stat-row">–õ–æ–≤–∫–æ—Å—Ç—å: <span id="dex">0</span> <button onclick="addStat('dex')">+</button></div>
        <div class="stat-row">–£–¥–∞—á–∞: <span id="luk">0</span> <button onclick="addStat('luk')">+</button></div>
        <button style="width:100%" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –ü–£–¢–¨</button>
    </div>

    <div id="city-screen" class="screen">
        <h2>üè∞ –ì–æ—Ä–æ–¥</h2>
        <button class="location-btn" onclick="initMultiplayer()">üåê –°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞ (PvP)</button>
        <button class="location-btn" onclick="showScreen('map-screen')">üó∫Ô∏è –ö–∞—Ä—Ç–∞ (PvE)</button>
        <div id="char-stats-display"></div>
        <button onclick="resetSave()" style="color:red; font-size:10px; margin-top:20px; border:none; background:none;">–°–±—Ä–æ—Å</button>
    </div>

    <div id="multiplayer-screen" class="screen">
        <h2>üåê –°–µ—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º</h2>
        <p id="peer-status">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID...</p>
        <div id="qrcode-container"></div>
        <input type="text" id="join-id" placeholder="ID –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞">
        <button onclick="joinGame()" style="width:100%">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button style="width:100%; margin-top:10px;" onclick="showScreen('city-screen')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="map-screen" class="screen">
        <h2>üó∫Ô∏è –ö–∞—Ä—Ç–∞</h2>
        <button class="location-btn" onclick="startBattle('–õ–µ—Å', 1)">üå≤ –õ–µ—Å</button>
        <button style="width:100%" onclick="showScreen('city-screen')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="combat-screen" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <div id="p-hp-ui">–í—ã: 100</div>
            <div id="e-hp-ui">–í—Ä–∞–≥: 100</div>
        </div>
        <div id="game-log"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
            <button onclick="setZone('attack','–ì–æ–ª–æ–≤–∞')">–ê—Ç:–ì–æ–ª–æ–≤–∞</button>
            <button onclick="setZone('attack','–ö–æ—Ä–ø—É—Å')">–ê—Ç:–ö–æ—Ä–ø—É—Å</button>
            <button onclick="setZone('attack','–ù–æ–≥–∏')">–ê—Ç:–ù–æ–≥–∏</button>
            <button onclick="setZone('block','–ì–æ–ª–æ–≤–∞')">–ó—â:–ì–æ–ª–æ–≤–∞</button>
            <button onclick="setZone('block','–ö–æ—Ä–ø—É—Å')">–ó—â:–ö–æ—Ä–ø—É—Å</button>
            <button onclick="setZone('block','–ù–æ–≥–∏')">–ó—â:–ù–æ–≥–∏</button>
        </div>
        <button id="turn-btn" disabled style="width:100%; background:#4a2; margin-top:10px;" onclick="confirmTurn()">–£–î–ê–†–ò–¢–¨</button>
    </div>

<script>
let p = { name: "–ì–µ—Ä–æ–π", str: 0, dex: 0, luk: 0, points: 25, hp: 100, maxHp: 100, gold: 0 };
let enemy = { name: "–í—Ä–∞–≥", hp: 0, maxHp: 0, str: 2, isPlayer: false };
let selection = { attack: null, block: null };
let peer, conn, remoteTurn = null;

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    updateUI();
}

function addStat(s) {
    if (p.points > 0) { p[s]++; p.points--; updateUI(); }
}

function updateUI() {
    p.maxHp = 100 + (p.str * 10);
    document.getElementById('free-points').innerText = p.points;
    document.getElementById('str').innerText = p.str;
    document.getElementById('dex').innerText = p.dex;
    document.getElementById('luk').innerText = p.luk;
    const info = document.getElementById('char-stats-display');
    if(info) info.innerHTML = `<b>${p.name}</b><br>HP: ${p.hp}/${p.maxHp} | –°–∏–ª–∞: ${p.str}`;
}

function startGame() {
    p.name = document.getElementById('player-name-input').value || "–ì–µ—Ä–æ–π";
    p.hp = p.maxHp;
    showScreen('city-screen');
}

function initMultiplayer() {
    showScreen('multiplayer-screen');
    if (peer) return;
    peer = new Peer();
    peer.on('open', id => {
        document.getElementById('peer-status').innerText = "–¢–≤–æ–π ID: " + id;
        document.getElementById('qrcode-container').innerHTML = `<img src="https://api.qrserver.com{id}">`;
    });
    peer.on('connection', c => { conn = c; setupConn(); });
    peer.on('error', e => alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.type));
}

function joinGame() {
    const id = document.getElementById('join-id').value;
    if(id) { conn = peer.connect(id); setupConn(); }
}

function setupConn() {
    conn.on('open', () => {
        showScreen('combat-screen');
        enemy = { name: "–°–æ–ø–µ—Ä–Ω–∏–∫", hp: 100, maxHp: 100, isPlayer: true, str: 5 };
        conn.send({ type: 'INIT', name: p.name, hp: p.maxHp, str: p.str });
    });
    conn.on('data', data => {
        if(data.type === 'INIT') { enemy.name = data.name; enemy.hp = data.hp; enemy.maxHp = data.hp; enemy.str = data.str; updateCombatUI(); }
        if(data.type === 'TURN') { remoteTurn = data; checkPvP(); }
    });
}

function startBattle(n, d) {
    enemy = { name: n, hp: 50*d, maxHp: 50*d, str: 3*d, isPlayer: false };
    p.hp = p.maxHp;
    showScreen('combat-screen');
    log("–ë–æ–π –Ω–∞—á–∞–ª—Å—è!", "#fff");
    updateCombatUI();
}

function setZone(t, z) {
    selection[t] = z;
    if(selection.attack && selection.block) document.getElementById('turn-btn').disabled = false;
}

function confirmTurn() {
    if(enemy.isPlayer) {
        conn.send({ type: 'TURN', attack: selection.attack, block: selection.block });
        document.getElementById('turn-btn').disabled = true;
        log("–ñ–¥–µ–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...", "#aaa");
        checkPvP();
    } else {
        const z = ['–ì–æ–ª–æ–≤–∞', '–ö–æ—Ä–ø—É—Å', '–ù–æ–≥–∏'];
        resolve(z[Math.floor(Math.random()*3)], z[Math.floor(Math.random()*3)]);
    }
}

function checkPvP() {
    if(selection.attack && remoteTurn) {
        resolve(remoteTurn.attack, remoteTurn.block);
        remoteTurn = null; selection = { attack: null, block: null };
        document.getElementById('turn-btn').disabled = true;
    }
}

function resolve(eAtk, eBlk) {
    log(`--- –†–∞—É–Ω–¥ ---`, "#666");
    if(selection.attack === eBlk) log("–í–∞—à —É–¥–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!", "#aaa");
    else { let d = 5+p.str; enemy.hp -= d; log(`–í—ã –Ω–∞–Ω–µ—Å–ª–∏ ${d} —É—Ä–æ–Ω–∞`, "#4a2"); }
    
    if(eAtk === selection.block) log("–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ —É–¥–∞—Ä!", "#4a2");
    else { let ed = 5+enemy.str; p.hp -= ed; log(`–í–∞–º –Ω–∞–Ω–µ—Å–ª–∏ ${ed} —É—Ä–æ–Ω–∞`, "#f44"); }
    
    updateCombatUI();
    if(p.hp <= 0 || enemy.hp <= 0) { alert(p.hp > 0 ? "–ü–æ–±–µ–¥–∞!" : "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ"); location.reload(); }
}

function updateCombatUI() {
    document.getElementById('p-hp-ui').innerText = `–í—ã: ${p.hp}`;
    document.getElementById('e-hp-ui').innerText = `${enemy.name}: ${enemy.hp}`;
}

function log(m, c) {
    const l = document.getElementById('game-log');
    l.innerHTML += `<div style="color:${c}">${m}</div>`;
    l.scrollTop = l.scrollHeight;
}

function resetSave() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
