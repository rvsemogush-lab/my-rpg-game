<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ë–ö: –ù–∞—Å–ª–µ–¥–∏–µ</title>
    <script src="https://unpkg.com"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #ccc; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .screen { display: none; width: 100%; max-width: 400px; border: 2px solid #444; padding: 20px; background: #222; }
        .active { display: block; }
        .stat-row { margin: 10px 0; display: flex; justify-content: space-between; }
        #game-log { height: 150px; border: 1px solid #555; overflow-y: auto; background: #000; padding: 10px; margin: 10px 0; font-size: 12px; }
        button { cursor: pointer; padding: 8px; background: #333; color: #fff; border: 1px solid #555; }
        #qrcode-container img { border: 5px solid white; }
    </style>
</head>
<body>

    <div id="char-creation" class="screen active">
        <h2>‚öîÔ∏è –ù–æ–≤—ã–π –ì–µ—Ä–æ–π</h2>
        <input type="text" id="p-name" placeholder="–ò–º—è..." style="width:90%; padding:5px;">
        <p>–û—á–∫–∏: <b id="f-pts">25</b></p>
        <div class="stat-row">–°–∏–ª–∞: <span id="s-str">0</span> <button onclick="addStat('str')">+</button></div>
        <div class="stat-row">–õ–æ–≤–∫–æ—Å—Ç—å: <span id="s-dex">0</span> <button onclick="addStat('dex')">+</button></div>
        <div class="stat-row">–£–¥–∞—á–∞: <span id="s-luk">0</span> <button onclick="addStat('luk')">+</button></div>
        <button style="width:100%" onclick="startGame()">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <div id="city-screen" class="screen">
        <h2>üè∞ –ì–æ—Ä–æ–¥</h2>
        <button style="width:100%" onclick="initNet()">üåê –°–µ—Ç–µ–≤–∞—è –∏–≥—Ä–∞</button>
        <div id="c-info" style="margin-top:15px; color:#4a2;"></div>
    </div>

    <div id="net-screen" class="screen">
        <h2>üåê –°–µ—Ç—å</h2>
        <p id="p-status">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID...</p>
        <div id="qrcode-container"></div>
        <input type="text" id="peer-id-input" placeholder="ID –¥—Ä—É–≥–∞" style="width:90%; margin-bottom:5px;">
        <button onclick="joinNet()" style="width:100%">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="showScreen('city-screen')" style="width:100%; margin-top:5px;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="combat-screen" class="screen">
        <div style="display:flex; justify-content:space-between;">
            <div id="p-hp">–í—ã: 100</div>
            <div id="e-hp">–í—Ä–∞–≥: 100</div>
        </div>
        <div id="game-log"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
            <button onclick="setZ('atk','–ì–æ–ª–æ–≤–∞')">–ê:–ì–æ–ª</button>
            <button onclick="setZ('atk','–¢–µ–ª–æ')">–ê:–¢–µ–ª</button>
            <button onclick="setZ('atk','–ù–æ–≥–∏')">–ê:–ù–æ–≥</button>
            <button onclick="setZ('blk','–ì–æ–ª–æ–≤–∞')">–ó:–ì–æ–ª</button>
            <button onclick="setZ('blk','–¢–µ–ª–æ')">–ó:–¢–µ–ª</button>
            <button onclick="setZ('blk','–ù–æ–≥–∏')">–ó:–ù–æ–≥</button>
        </div>
        <button id="hit-btn" disabled style="width:100%; background:#4a2; margin-top:10px;" onclick="doTurn()">–£–î–ê–†–ò–¢–¨</button>
    </div>

<script>
let p = { name: "–ì–µ—Ä–æ–π", str: 0, dex: 0, luk: 0, pts: 25, hp: 100, max: 100 };
let enemy = { name: "–í—Ä–∞–≥", hp: 0, max: 0, str: 5 };
let sel = { atk: null, blk: null };
let peer, conn, rem = null;

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    updateUI();
}

function addStat(s) {
    if (p.pts > 0) { p[s]++; p.pts--; updateUI(); }
}

function updateUI() {
    p.max = 100 + (p.str * 10);
    document.getElementById('f-pts').innerText = p.pts;
    document.getElementById('s-str').innerText = p.str;
    document.getElementById('s-dex').innerText = p.dex;
    document.getElementById('s-luk').innerText = p.luk;
    if(document.getElementById('c-info')) document.getElementById('c-info').innerText = p.name + " | HP: " + p.hp + "/" + p.max;
}

function startGame() {
    p.name = document.getElementById('p-name').value || "–ì–µ—Ä–æ–π";
    p.hp = p.max;
    showScreen('city-screen');
}

function initNet() {
    showScreen('net-screen');
    if (peer) return;
    peer = new Peer();
    peer.on('open', (id) => {
        document.getElementById('p-status').innerText = "–¢–≤–æ–π ID: " + id;
        document.getElementById('qrcode-container').innerHTML = '<img src="https://api.qrserver.com' + id + '">';
    });
    peer.on('connection', (c) => { conn = c; setupConn(); });
}

function joinNet() {
    const id = document.getElementById('peer-id-input').value;
    if(id) { conn = peer.connect(id); setupConn(); }
}

function setupConn() {
    conn.on('open', () => {
        showScreen('combat-screen');
        enemy.name = "–°–æ–ø–µ—Ä–Ω–∏–∫";
        conn.send({ t: 'INIT', n: p.name, h: p.max, s: p.str });
    });
    conn.on('data', (d) => {
        if(d.t === 'INIT') { enemy.name = d.n; enemy.hp = d.h; enemy.max = d.h; enemy.str = d.s; updC(); }
        if(d.t === 'TURN') { rem = d; checkPvP(); }
    });
}

function setZ(t, z) {
    sel[t] = z;
    if(sel.atk && sel.blk) document.getElementById('hit-btn').disabled = false;
}

function doTurn() {
    conn.send({ t: 'TURN', a: sel.atk, b: sel.blk });
    document.getElementById('hit-btn').disabled = true;
    log("–ñ–¥–µ–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...", "#aaa");
    checkPvP();
}

function checkPvP() {
    if(sel.atk && rem) {
        log("--- –†–∞—É–Ω–¥ ---", "#666");
        if(sel.atk === rem.b) log("–í–∞—à —É–¥–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!", "#aaa");
        else { let d = 5 + p.str; enemy.hp -= d; log("–í—ã –Ω–∞–Ω–µ—Å–ª–∏ " + d, "#4a2"); }
        
        if(rem.a === sel.blk) log("–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ —É–¥–∞—Ä!", "#4a2");
        else { let ed = 5 + enemy.str; p.hp -= ed; log("–í–∞–º –Ω–∞–Ω–µ—Å–ª–∏ " + ed, "#f44"); }
        
        updC();
        rem = null; sel = { atk: null, blk: null };
        if(p.hp <= 0 || enemy.hp <= 0) { alert("–ë–æ–π –æ–∫–æ–Ω—á–µ–Ω!"); location.reload(); }
    }
}

function updC() {
    document.getElementById('p-hp').innerText = "–í—ã: " + p.hp;
    document.getElementById('e-hp').innerText = enemy.name + ": " + enemy.hp;
}

function log(m, c) {
    const l = document.getElementById('game-log');
    l.innerHTML += '<div style="color:' + c + '">' + m + '</div>';
    l.scrollTop = l.scrollHeight;
}
</script>
</body>
</html>
